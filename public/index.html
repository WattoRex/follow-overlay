<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Overlay — Barre de followers Twitch</title>
    <style>
        :root {
            --bg: linear-gradient(180deg, #FFF7F2, #FFEFEF 60%);
            --card-bg: rgba(255, 255, 255, 0.7);
            --accent-start: #FFD7E8;
            --accent-end: #FFB0D1;
            --muted: #9b7a86;
            --glass: rgba(255, 255, 255, 0.6);
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: transparent;
        }

        /* Container sized for OBS Browser Source */
        .overlay-card {
            width: 760px;
            height: 140px;
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 16px;
            box-sizing: border-box;
            background: transparent;
        }

        .art {
            width: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .svg-wrap {
            width: 120px;
            height: 120px;
        }

        /* Middle: bar area */
        .bar-area {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .track {
            width: 100%;
            height: 28px;
            border-radius: 900px;
            padding: 6px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.85));
            box-shadow: 0 6px 20px rgba(160, 100, 130, 0.06) inset;
            position: relative;
            overflow: hidden;
        }

        .fill {
            height: 100%;
            border-radius: 900px;
            width: 20%;
            position: relative;
            transition: width 800ms cubic-bezier(.2, .9, .3, 1);
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            box-shadow: 0 6px 18px rgba(255, 160, 200, 0.12) inset;
        }

        /* Rider: bubble tea */
        .rider {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            left: 10%;
            width: 76px;
            height: 76px;
            pointer-events: none;
            transition: left 900ms cubic-bezier(.2, .9, .3, 1);
            z-index: 11;
        }

        .rider .bob {
            animation: bob 2400ms ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes bob {
            0% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-6px)
            }

            100% {
                transform: translateY(0)
            }
        }

        /* steam animation for the rider */
        .rider .steam path {
            stroke: #fff;
            stroke-width: 2;
            stroke-linecap: round;
            fill: none;
        }

        .rider .steam .s1 {
            animation: steam 2200ms ease-in-out infinite;
        }

        .rider .steam .s2 {
            animation: steam 2600ms ease-in-out infinite;
            animation-delay: 300ms;
        }

        @keyframes steam {
            0% {
                transform: translateY(8px);
                opacity: 0
            }

            40% {
                opacity: 0.9;
                transform: translateY(-6px)
            }

            100% {
                opacity: 0;
                transform: translateY(-18px)
            }
        }

        /* Bulles dynamiques dans le fill */
        .fill .bubble {
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: bubbleUp linear infinite;
        }

        @keyframes bubbleUp {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 0.6;
            }

            50% {
                transform: translateY(-14px) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-28px) scale(0.8);
                opacity: 0;
            }
        }

        /* small floating hearts (idle life) */
        .heart-pulse {
            position: absolute;
            right: 10px;
            bottom: 6px;
            opacity: 0.9;
        }

        @media (max-width:640px) {
            .overlay-card {
                width: 94vw;
                height: 120px;
                padding: 10px;
            }

            .art {
                width: 96px;
            }

            .rider {
                width: 64px;
                height: 64px;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* CONFIG MENU */
        .config {
            width: 740px;
            background: var(--bg-light);
            border-radius: 12px;
            padding: 14px;
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .config h3 {
            margin: 0;
            font-size: 1rem;
            color: #444;
        }

        .config label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .config input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .config button {
            align-self: flex-end;
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            border: none;
            color: #333;
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .config button:hover {
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .counter {
            position: absolute;
            width: 100%;
            text-align: center;
            font-weight: 700;
            color: #3b2a30;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 10;
            top: 10px;
        }
    </style>
</head>

<body>
    <div class="overlay-card" id="overlay">

        <div class="art" aria-hidden="true">
            <div class="svg-wrap">
                <rect x="8" y="8" width="184" height="184" rx="34" fill="#FFF4F6" stroke="#FFD7E0" />
                <g transform="translate(18,36)">
                    <rect x="0" y="36" width="110" height="62" rx="18" fill="#FFFBF8" stroke="#F1D0D0" />
                    <ellipse cx="55" cy="36" rx="55" ry="12" fill="#FFD27F" opacity="0.95" />
                    <g transform="translate(30,58)" class="cup-eyes">
                        <circle cx="6" cy="6" r="5" fill="#3b2a30" />
                        <circle cx="36" cy="6" r="5" fill="#3b2a30" />
                    </g>
                </g>
            </div>
        </div>

        <div class="bar-area">
            <div class="track" id="track">
                <div class="counter" id="counter">0 / 100</div>
                <div class="fill" id="fill"></div>
            </div>

            <!-- rider bubble tea -->
            <!-- <div class="rider" id="rider" aria-hidden="true">
                <div class="bob">
                    <svg viewBox="0 0 120 120" class="bubble-svg" width="100%" height="100%"
                        xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="cupG2" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#fff7f3" stop-opacity="0.6" />
                                <stop offset="100%" stop-color="#fff0f6" stop-opacity="0.3" />
                            </linearGradient>
                            <linearGradient id="teaG2" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#ffd7e8" />
                                <stop offset="100%" stop-color="#ffb0d1" />
                            </linearGradient>
                            <linearGradient id="teaHighlight" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="white" stop-opacity="0.35" />
                                <stop offset="100%" stop-color="white" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                        <g transform="translate(0,6)">
                            <rect x="56" y="-12" width="8" height="64" rx="3" fill="#ffd7e0"
                                transform="rotate(10 60 20)" />
                            <path d="M28 36c-6 0-10 6-8 12l8 32c1 5 8 8 32 8s31-3 32-8l8-32c2-6-2-12-8-12H28z"
                                fill="url(#teaG2)" />
                            <path d="M28 36c-6 0-10 6-8 12l8 32c1 5 8 8 32 8s31-3 32-8l8-32c2-6-2-12-8-12H28z"
                                fill="url(#teaHighlight)" />
                            <g id="pearls">
                                <circle cx="44" cy="68" r="5.5" fill="#302a2a" opacity="0.95" />
                                <circle cx="60" cy="72" r="5.5" fill="#302a2a" opacity="0.95" />
                                <circle cx="76" cy="68" r="5.5" fill="#302a2a" opacity="0.95" />
                            </g>
                            <g transform="translate(36,50)">
                                <circle cx="6" cy="6" r="4" fill="#3b2a30" />
                                <circle cx="36" cy="6" r="4" fill="#3b2a30" />
                                <circle cx="10" cy="12" r="2" fill="#FFB0D1" opacity="0.6" />
                                <circle cx="32" cy="12" r="2" fill="#FFB0D1" opacity="0.6" />
                            </g>
                            <path d="M28 32c-6 0-10 6-8 14l8 40c1 6 8 10 32 10s31-4 32-10l8-40c2-8-2-14-8-14H28z"
                                fill="url(#cupG2)" stroke="#f2d1c7" stroke-width="2" />
                            <path d="M34 36c-1 10 2 32 2 40" stroke="white" stroke-width="2" stroke-linecap="round"
                                opacity="0.3" />
                            <g class="steam" transform="translate(54,-4)" stroke="#e5bfc9" stroke-width="1.2"
                                fill="none">
                                <path class="s1" d="M6 44c4-12 12-18 6-26" />
                                <path class="s2" d="M20 44c4-12 12-18 6-26" />
                            </g>
                        </g>
                    </svg>
                </div>
            </div> -->

            <!-- rider bubble tea -->
            <div class="rider" id="rider" aria-hidden="true">
                <div class="bob">
                    <svg viewBox="0 0 120 120" class="bubble-svg" width="100%" height="100%"
                        xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <!-- tasse -->
                            <linearGradient id="cupG2" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="var(--cup-color-start, #fff7f3)" stop-opacity="0.6" />
                                <stop offset="100%" stop-color="var(--cup-color-end, #fff0f6)" stop-opacity="0.3" />
                            </linearGradient>
                            <!-- thé -->
                            <linearGradient id="teaG2" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="var(--accent-start, #FFD7E8)" />
                                <stop offset="100%" stop-color="var(--accent-end, #FFB0D1)" />
                            </linearGradient>
                            <linearGradient id="teaHighlight" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="white" stop-opacity="0.35" />
                                <stop offset="100%" stop-color="white" stop-opacity="0" />
                            </linearGradient>
                        </defs>

                        <g transform="translate(0,6)">
                            <!-- paille -->
                            <rect x="56" y="-12" width="8" height="64" rx="3" fill="var(--straw-color, #ffd7e0)"
                                transform="rotate(10 60 20)" />

                            <!-- thé -->
                            <path d="M28 36c-6 0-10 6-8 12l8 32c1 5 8 8 32 8s31-3 32-8l8-32c2-6-2-12-8-12H28z"
                                fill="url(#teaG2)" />
                            <path d="M28 36c-6 0-10 6-8 12l8 32c1 5 8 8 32 8s31-3 32-8l8-32c2-6-2-12-8-12H28z"
                                fill="url(#teaHighlight)" />

                            <!-- perles -->
                            <g id="pearls">
                                <circle cx="44" cy="68" r="5.5" fill="var(--pearls-color, #302a2a)" opacity="0.95" />
                                <circle cx="60" cy="72" r="5.5" fill="var(--pearls-color, #302a2a)" opacity="0.95" />
                                <circle cx="76" cy="68" r="5.5" fill="var(--pearls-color, #302a2a)" opacity="0.95" />
                            </g>

                            <g transform="translate(36,50)">
                                <circle cx="6" cy="6" r="4" fill="var(--pearls-color, #3b2a30)" />
                                <circle cx="36" cy="6" r="4" fill="var(--pearls-color, #3b2a30)" />
                                <circle cx="10" cy="12" r="2" fill="var(--accent-end, #FFB0D1)" opacity="0.6" />
                                <circle cx="32" cy="12" r="2" fill="var(--accent-end, #FFB0D1)" opacity="0.6" />
                            </g>

                            <!-- tasse -->
                            <path d="M28 32c-6 0-10 6-8 14l8 40c1 6 8 10 32 10s31-4 32-10l8-40c2-8-2-14-8-14H28z"
                                fill="url(#cupG2)" stroke="var(--cup-color, #f2d1c7)" stroke-width="2" />

                            <path d="M34 36c-1 10 2 32 2 40" stroke="white" stroke-width="2" stroke-linecap="round"
                                opacity="0.3" />

                            <!-- vapeur -->
                            <g class="steam" transform="translate(54,-4)" stroke="var(--steam-color, #e5bfc9)"
                                stroke-width="1.2" fill="none">
                                <path class="s1" d="M6 44c4-12 12-18 6-26" />
                                <path class="s2" d="M20 44c4-12 12-18 6-26" />
                            </g>
                        </g>
                    </svg>
                </div>
            </div>


            <!-- small decorative hearts -->
            <div class="heart-pulse" aria-hidden="true">
                <!-- <svg width="36" height="30" viewBox="0 0 24 24">
          <defs>
            <linearGradient id="heartGradient" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#FFD7E8" />
              <stop offset="100%" stop-color="#FFB0D1" />
            </linearGradient>
          </defs>
          <path d="M12 21s-8-5-8-11a5 5 0 0 1 10 0 5 5 0 0 1 10 0c0 6-8 11-8 11z" fill="url(#heartGradient)"
            stroke="white" stroke-width="0.8" stroke-linejoin="round" />
        </svg> -->
            </div>

            <div class="sr-only" id="sr">Subs: <span id="srFollowers">0</span> / <span id="srGoal">100</span></div>
        </div>
    </div>

    <div class="config" id="configMenu">
        <label>Nom Twitch :
            <input type="text" id="usernameInput" placeholder="ex: gotaga">
        </label>
        <label>Objectif :
            <input type="number" id="goalInput" value="100" min="1">
        </label>
        <label>Thème :
            <select id="themeSelect">
                <option value="pink">Bubble Tea Rose</option>
                <option value="green">Bubble Tea Vert</option>
                <option value="orange">Bubble Tea Orange</option>
                <option value="yellow">Bubble Tea Jaune</option>
                <option value="blue">Bubble Tea Bleu</option>
                <option value="purple">Bubble Tea Violet</option>
                <option value="mint">Bubble Tea Menthe</option>
                <option value="choco">Bubble Tea Chocolat</option>
            </select>

        </label>
        <button id="saveBtn">💾 Sauvegarder</button>

        <label>URL pour OBS :</label>
        <input type="text" id="overlayUrl" class="hidden" readonly onclick="this.select()">
        <small>Copie cette URL et colle-la dans ta source Navigateur OBS</small>

    </div>


    <script>
        const fill = document.getElementById("fill");
        const counter = document.getElementById("counter");
        const usernameInput = document.getElementById("usernameInput");
        const goalInput = document.getElementById("goalInput");
        const saveBtn = document.getElementById("saveBtn");
        const themeSelect = document.getElementById("themeSelect");
        const root = document.documentElement;

        // Lecture des données sauvegardées
        let username = localStorage.getItem("twitch_username") || "";
        let goal = parseInt(localStorage.getItem("twitch_goal") || "100", 10);


        if (username) usernameInput.value = username;
        goalInput.value = goal;

        let theme = localStorage.getItem("twitch_theme") || "pink";
        themeSelect.value = theme;
        setTheme(theme);

        // Affiche l’URL dans la config
        function displayOverlayURL() {
            const urlDisplay = document.getElementById("overlayUrl");
            const base = window.location.origin + window.location.pathname;
            const finalURL = `${base}?user=${encodeURIComponent(username)}&goal=${goal}&theme=${theme}`;
            urlDisplay.value = finalURL;
            urlDisplay.classList.remove("hidden");
        }

        // Fonction principale de mise à jour
        async function updateFollowers() {
            let goal = 100; // valeur par défaut avant lecture de l’URL
            const params = new URLSearchParams(window.location.search);
            const userFromURL = params.get("user");
            const goalFromURL = parseInt(params.get("goal") || goal, 10);
            const themeFromURL = params.get("theme");


            const currentUser = userFromURL || username;
            const currentGoal = goalFromURL || goal;
            const currentTheme = themeFromURL || theme;

            if (!currentUser) {
                counter.textContent = "⚠️ Aucun utilisateur défini";
                return;
            }

            try {
                const res = await fetch(`/api/followers?user=${encodeURIComponent(currentUser)}`, { cache: "no-store" });
                if (!res.ok) throw new Error("Erreur API Twitch");

                const data = await res.json();
                const followers = data.followers_total || 0;
                const pct = Math.min(100, (followers / currentGoal) * 100);

                fill.style.width = pct + "%";

                const rider = document.getElementById("rider");
                const track = document.getElementById("track");
                const trackWidth = track.offsetWidth;
                const fillWidth = trackWidth * (pct / 100);
                rider.style.left = (fillWidth / trackWidth * 100) + "%";

                counter.textContent = `${followers} / ${currentGoal}`;
            } catch (e) {
                console.error("Erreur récupération followers:", e);
                counter.textContent = "⚠️ Erreur API";
            }
        }

        // Sauvegarde config locale
        saveBtn.addEventListener("click", () => {
            username = usernameInput.value.trim();
            goal = parseInt(goalInput.value, 10);
            theme = themeSelect.value;
            localStorage.setItem("twitch_username", username);
            localStorage.setItem("twitch_goal", goal);
            localStorage.setItem("twitch_theme", theme);
            setTheme(theme);
            updateFollowers();
            displayOverlayURL();
        });


        // Fonction pour appliquer un thème
        function setTheme(theme) {
            switch (theme) {
                case "pink": // Bubble Tea Rose
                    root.style.setProperty("--accent-start", "#FFD7E8");
                    root.style.setProperty("--accent-end", "#FFB0D1");
                    root.style.setProperty("--cup-color", "#ffd7e0");
                    root.style.setProperty("--straw-color", "#ffd7e0");
                    root.style.setProperty("--pearls-color", "#302a2a");
                    root.style.setProperty("--steam-color", "#e5bfc9");
                    break;

                case "green":
                    root.style.setProperty("--accent-start", "#B8F1B0");
                    root.style.setProperty("--accent-end", "#7ED957");
                    root.style.setProperty("--cup-color", "#a0e07f");
                    root.style.setProperty("--straw-color", "#a0e07f");
                    root.style.setProperty("--pearls-color", "#1b3a1b");
                    root.style.setProperty("--steam-color", "#c0e5b0");
                    break;

                case "orange":
                    root.style.setProperty("--accent-start", "#FFD79F");
                    root.style.setProperty("--accent-end", "#FFA63B");
                    root.style.setProperty("--cup-color", "#ffc487");
                    root.style.setProperty("--straw-color", "#ffc487");
                    root.style.setProperty("--pearls-color", "#663300");
                    root.style.setProperty("--steam-color", "#ffe0b0");
                    break;

                case "yellow":
                    root.style.setProperty("--accent-start", "#FFF799");
                    root.style.setProperty("--accent-end", "#FFD700");
                    root.style.setProperty("--cup-color", "#fff466");
                    root.style.setProperty("--straw-color", "#fff466");
                    root.style.setProperty("--pearls-color", "#b38f00");
                    root.style.setProperty("--steam-color", "#fff7b3");
                    break;

                case "blue":
                    root.style.setProperty("--accent-start", "#A0E8FF");
                    root.style.setProperty("--accent-end", "#4CC3FF");
                    root.style.setProperty("--cup-color", "#9fdfff");
                    root.style.setProperty("--straw-color", "#9fdfff");
                    root.style.setProperty("--pearls-color", "#1e3a5f");
                    root.style.setProperty("--steam-color", "#bde9ff");
                    break;

                case "purple":
                    root.style.setProperty("--accent-start", "#D6B4FC");
                    root.style.setProperty("--accent-end", "#9A5DFF");
                    root.style.setProperty("--cup-color", "#caa8ff");
                    root.style.setProperty("--straw-color", "#caa8ff");
                    root.style.setProperty("--pearls-color", "#341e4a");
                    root.style.setProperty("--steam-color", "#d9b8ff");
                    break;

                case "mint":
                    root.style.setProperty("--accent-start", "#C2FFF2");
                    root.style.setProperty("--accent-end", "#6FE1CC");
                    root.style.setProperty("--cup-color", "#a4f2de");
                    root.style.setProperty("--straw-color", "#a4f2de");
                    root.style.setProperty("--pearls-color", "#144d3a");
                    root.style.setProperty("--steam-color", "#b9f7eb");
                    break;

                case "choco":
                    root.style.setProperty("--accent-start", "#C49A6C");
                    root.style.setProperty("--accent-end", "#8B5E3C");
                    root.style.setProperty("--cup-color", "#c29b74");
                    root.style.setProperty("--straw-color", "#a6744a");
                    root.style.setProperty("--pearls-color", "#3a1f0b");
                    root.style.setProperty("--steam-color", "#e0c7a4");
                    break;
            }
        }



        // Changement thème à la volée
        themeSelect.addEventListener("change", (e) => {
            theme = e.target.value;
            setTheme(theme);
            localStorage.setItem("twitch_theme", theme);
        });

        saveBtn.addEventListener("click", () => {
            username = usernameInput.value.trim();
            goal = parseInt(goalInput.value, 10);
            localStorage.setItem("twitch_username", username);
            localStorage.setItem("twitch_goal", goal);
            localStorage.setItem("twitch_theme", theme);
            updateFollowers();
            setTheme(theme);
        });

        // Auto-refresh toutes les 60 secondes
        setInterval(updateFollowers, 60000);

        // Premier chargement auto
        updateFollowers();
    </script>
</body>

</html>